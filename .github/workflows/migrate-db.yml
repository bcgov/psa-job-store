name: Migrate DB Schema
on:
  repository_dispatch:
    types: [migrate-trigger]

jobs:
  metadata:
    name: Get Metadata
    runs-on: ubuntu-20.04
    environment: dev

    outputs:
      changed-apps: ${{ steps.get-changed-apps.outputs.changes }}
    steps:
      - name: Debug Info
        run: |
          echo "Ref: ${{ github.event.client_payload.ref }}"
          echo "Ref Name: ${{ github.event.client_payload.ref_name }}"
          echo "SHA: ${{ github.event.client_payload.sha }}"
          echo "Full Ref: refs/heads/${{ github.event.client_payload.ref_name }}"
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: refs/heads/${{ github.event.client_payload.ref_name }}
          fetch-depth: 0
      - name: Get Changed Apps
        id: get-changed-apps
        uses: dorny/paths-filter@v2
        with:
          base: refs/heads/${{ github.event.client_payload.ref_name }}
          ref: refs/heads/${{ github.event.client_payload.ref_name }}
          filters: |
            api:
              - 'apps/api/prisma/migrations/**'
  migrate:
    name: Migrate DB Schema
    needs: metadata
    if: ${{ needs.metadata.outputs.changed-apps != '[]' && needs.metadata.outputs.changed-apps != '' }}
    runs-on: ubuntu-20.04
    environment:
      name: ${{ github.event.client_payload.ref_name == 'main' && 'prod' || github.event.client_payload.ref_name == 'stage' && 'test' || 'dev' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: refs/heads/${{ github.event.client_payload.ref_name }}
          fetch-depth: 0
      - name: 'migrate db'
        uses: ./.github/actions/migrate-db
        with:
          environment: ${{ github.event.client_payload.ref_name == 'main' && 'prod' || github.event.client_payload.ref_name == 'stage' && 'test' || 'dev' }}
          openshift-server: ${{ secrets.OPENSHIFT_SERVER }}
          api-token: ${{ secrets.OPENSHIFT_API_TOKEN }}
      - name: Create Version Changeset
        run: npm install @changesets/cli && npx changeset version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit Version
        if: ${{ github.event.client_payload.ref_name == 'stage' }}
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'Update version [skip ci]'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Trigger Deployments
        uses: ./.github/actions/trigger-deploy
        with:
          openshift-server: ${{ secrets.OPENSHIFT_SERVER }}
          api-token: ${{ secrets.OPENSHIFT_API_TOKEN }}
          project: ${{ needs.metadata.outputs.changed-apps }}
          environment: ${{ github.event.client_payload.ref_name == 'main' && 'prod' || github.event.client_payload.ref_name == 'stage' && 'test' || 'dev' }}
      - name: Debug E2E Trigger Conditions
        run: |
          echo "Previous step success: ${{ success() }}"
          echo "Branch name: ${{ github.event.client_payload.ref_name }}"
          echo "Should trigger: ${{ success() && github.event.client_payload.ref_name == 'dev' }}"
      - name: Trigger E2E Tests
        if: success() && github.event.client_payload.ref_name == 'dev'
        uses: actions/github-script@v6
        with:
          script: |
            try {
              console.log('Attempting to trigger E2E tests');
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'e2e.yml',
                ref: 'refs/heads/${{ github.event.client_payload.ref_name }}'
              });
              console.log('E2E tests triggered successfully');
            } catch (error) {
              console.log('Error triggering E2E tests:', error);
              throw error;
            }